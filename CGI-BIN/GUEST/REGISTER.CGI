#!/usr/bin/perl
#------------------------------------------------------#
#                                                      #
#              ±¾³ÌĞòÎª ÖĞ¹úCGIÖ®¼Ò Ìá¹©	           #
#              AjieµÄÁôÑÔ°å¶àÓÃ»§°æV4.0                #
#------------------------------------------------------#
&mypath;
require "$mypath/"."info/setup.cgi";
require "$mypath/"."info/style.cgi";
require "$mypath/"."sub.cgi";
&parseadminform;
&header;
######################################################
if ($FORM{'action'} eq "modify"){&modify;exit;}
if ($FORM{'action'} eq "adduser"||$FORM{'action'} eq "modifyuser"){&adduser;exit;}
if ($shenqing eq "off")
     {
      &errorinput("ÁôÑÔ±¾ÔİÍ£ÉêÇë");
     }
&pagestyle;
print qq(
<html>
    <head>
    <title>ÉêÇëÁôÑÔ±¾</title>
    <meta http-equiv="Content-Type" content="text/html; charset=gb2312">
$pagestyle
    </head>
    <body bgcolor="$gbbgcolor" $gbbody>
);
print qq~
<form method=POST action=$cgiurl/register.cgi?action=adduser>
<table width=$tablewidth align=center cellspacing=0 cellpadding=0  border=0 bgcolor=$tbcolor><tr><td>
      <table width=100% cellspacing=1 cellpadding=4 border=0 height="100%">
        <tr>
          <td bgcolor=$btbgcolor colspan="2">
            <div align="center"><font color=$btfont>Éê Çë Áô ÑÔ ±¾</font></div>
          </td>
        </tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ÓÃ »§ Ãû£º</td>
<td width="70%">&nbsp;
<input type="text" name="username" size="20" maxlength=8 class="input2">&nbsp;&nbsp;&nbsp;&nbsp; * 1-8Î»£¨°æÖ÷ÓÃ»§Ãû£©
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ÓÃ»§ÃÜÂë£º</td>
<td width="70%">&nbsp;
<input type="password" name="userpass" size="20" class="input2">&nbsp;&nbsp;&nbsp;&nbsp; * °æÖ÷ÃÜÂë
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ÖØ¸´ÃÜÂë£º</td>
<td width="70%">&nbsp;
<input type="password" name="userpass1" size="20" class="input2">&nbsp;&nbsp;&nbsp;&nbsp; * °æÖ÷ÃÜÂë
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">µç×ÓÓÊ¼ş£º</td>
<td width="70%">&nbsp;
<input type="text" name="emailaddress" size="20" class="input2" value="@">&nbsp;&nbsp;&nbsp; &nbsp;* ÓÊ¼şµØÖ·(ÓÊ¼şÍ¨Öª£©
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">Ö÷Ò³µØÖ·£º</td>
<td width="70%">&nbsp;
<input type="text" name="homepage" value = "http://" size="20" class="input2">&nbsp;&nbsp;&nbsp;&nbsp; * Ö÷Ò³µØÖ·
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ÁôÑÔ±¾Ãû£º</td>
<td width="70%">&nbsp;
<input type="text" name="title" size="20" value="ÎÒµÄÁôÑÔ±¾" class="input2">&nbsp;&nbsp;&nbsp;&nbsp; * ÄãµÄÁôÑÔ±¾µÄÃû×Ö
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">Ã¿Ò³¼ÇÂ¼£º</td>
<td width="70%">&nbsp;
<input type="text" name="recode" size="20" value="$pagenum" maxlength="2" class="input2">&nbsp;&nbsp;&nbsp;&nbsp; * Ä¬ÈÏÎª$pagenumÌõ
</td>
</tr>
        <tr><td bgcolor=$btbgcolor colspan="2"><div align="center">
<input type="submit" value="Ìá½»ÉêÇë" name="B1" class="input2">&nbsp;&nbsp;&nbsp;&nbsp;
			  <input type="reset"  value="ÖØĞÂÀ´¹ı" name="B2" class="input2"></div>
</td></tr></table>
</td></tr></table>
</form>
~;
sub modify{
$user=$FORM{'user'};
dbmopen (%USER,"$userpath/alluser.db",0666);
foreach (%USER){
if ($_ =~ "¡¬$user¡¬")
{
($mark,$name,$pass,$email,$url,$title,$pagenum,$ipaddress,$date_time,$markend,$last)=split(/¡¬/,$_);
dbmclose(%USER);
}}
&pagestyle;
print qq~
<html>
    <head>
    <title>ĞŞ¸ÄÁôÑÔ±¾ĞÅÏ¢</title>
    <meta http-equiv="Content-Type" content="text/html; charset=gb2312">
$pagestyle
    </head>
    <body bgcolor="$gbbgcolor" $gbbody>
<form method="POST" action="$cgiurl/register.cgi?action=modifyuser&user=$user">
<table width=$tablewidth align=center cellspacing=0 cellpadding=0  border=0 bgcolor=$tbcolor><tr><td>
      <table width=100% cellspacing=1 cellpadding=4 border=0 height="100%">
        <tr>
          <td bgcolor=$btbgcolor colspan="2">
            <div align="center"><font color=$btfont>ĞŞ¸Ä <font color=red>$user</font> ÁôÑÔ±¾ĞÅÏ¢</font></div>
          </td>
        </tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ÓÃ »§ Ãû£º</td>
<td width="70%">&nbsp;&nbsp;<font color=red>$user</font>
<input type="hidden" name="username" value="$user">
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ÓÃ»§ÃÜÂë£º</td>
<td width="70%">&nbsp;
<input type="password" name="userpass" size="20" class="input2">&nbsp;&nbsp;&nbsp;&nbsp; * °æÖ÷ÃÜÂë
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ÖØ¸´ÃÜÂë£º</td>
<td width="70%">&nbsp;
<input type="password" name="userpass1" size="20" class="input2">&nbsp;&nbsp;&nbsp;&nbsp; * °æÖ÷ÃÜÂë
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">µç×ÓÓÊ¼ş£º</td>
<td width="70%">&nbsp;
<input type="text" name="emailaddress" size="20" class="input2" value="$email">&nbsp;&nbsp;&nbsp; &nbsp;* ÓÊ¼şµØÖ·(ÓÊ¼şÍ¨Öª£©
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">Ö÷Ò³µØÖ·£º</td>
<td width="70%">&nbsp;
<input type="text" name="homepage" value = "$url" size="20" class="input2">&nbsp;&nbsp;&nbsp;&nbsp; * Ö÷Ò³µØÖ·
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ÁôÑÔ±¾Ãû£º</td>
<td width="70%">&nbsp;
<input type="text" name="title" size="20" value="$title" class="input2">&nbsp;&nbsp;&nbsp;&nbsp; * ÄãµÄÁôÑÔ±¾µÄÃû×Ö
</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">Ã¿Ò³¼ÇÂ¼£º</td>
<td width="70%">&nbsp;
<input type="text" name="recode" size="20" value="$pagenum" maxlength="2" class="input2">&nbsp;&nbsp;&nbsp;&nbsp; * Ä¬ÈÏÎª$pagenumÌõ
</td>
</tr>
        <tr><td bgcolor=$btbgcolor colspan="2"><div align="center">
<input type="submit" value="Ìá½»ÉêÇë" name="B1" class="input2">&nbsp;&nbsp;&nbsp;&nbsp;
			  <input type="reset"  value="ÖØĞÂÀ´¹ı" name="B2" class="input2"></div>
</td></tr></table>
</td></tr></table>
</form>
</table>
<table border="0" width=$tablewidth>
<tr align=middle>
<td width=100%><br>
<p align="center">Ãâ·ÑÁôÑÔ±¾ÓÉ<b><a href=$homeurl target=_blank> $home </a></b>
Ìá¹© ¼¼ÊõÖ§³Ö£º<b><a href=http://www.cgiubb.com target=_blank> CGI¼¼ÊõÂÛÌ³</a></b></p>
</td>
</tr>
</table>
~;
}
print qq~
</table>
<table border="0" width=$tablewidth>
<tr align=middle>
<td width=100%><br>
<p align="center">Ãâ·ÑÁôÑÔ±¾ÓÉ<b><a href=$homeurl target=_blank> $home </a></b>
Ìá¹© ¼¼ÊõÖ§³Ö£º<b><a href=http://www.cgiubb.com target=_blank> CGI¼¼ÊõÂÛÌ³</a></b></p>
</td>
</tr>
</table>
~;
#############
sub adduser
   {
    if ($FORM{show} eq "show")
       {
       	$linkurl = "$cgiurl/register.cgi";
        print "<META HTTP-EQUIV=REFRESH CONTENT=\"1;URL=$linkurl\">";
       }
    else
       {
       	if ($FORM{'action'} eq 'adduser')
       	   {
       	    $name       = &checknull($FORM{'username'}   ,"Ãû×ÖÏî²»ÄÜÎª¿Õ!!");
            if (length($name)>8) {&errorinput("Ãû×Ö²»ÄÜ³¬¹ı8¸ö×Ö·û£¡");}
            if($name=~m/[\#\&\*\=\+\\\:\"\/\<\>\?ÿ-]/){&errorinput("Ãû×ÖÖĞ²»ÄÜº¬ÓĞÌØÊâ×Ö·û!");}
	        $name =~ s/\&nbsp\;//ig;
	        $name =~ s/¡¡/ /g;
	        $name =~ s/©¡/ /g;
	        $name =~ s/[ ]+/ /g;
	        $name =~ s/\s*$//g;
    	    $name =~ s/^\s*//g;
	        $name =~ s/ *$//g;
	        $name =~ s/^ *//g;
    	    $name =~ s/[ ]+/ /;
	        $name =~ s/[ ]+/ /;
	        $name =~ s/ÿ//isg;
    	    $name =~ s///isg;
	        $name =~ s/()+//isg;
            $name =~ tr/A-Z/a-z/;
	        $name =~ s/[\a\f\n\e\0\r\t\`\~\!\@\#\$\%\^\&\*\(\)\=\+\\\[\]\{\}\;\'\:\"\,\.\/\<\>\?]//isg;
            if($FORM{'userpass'}=~m/[\#\&\*\=\+\\\:\"\/\<\>\?ÿ-]/){&errorinput("ÃÜÂëÖĞ²»ÄÜº¬ÓĞÌØÊâ×Ö·û!");}
       	    $email      = &checknull($FORM{'emailaddress'}  ,"µç×ÓÓÊ¼şÏî²»ÄÜÎª¿Õ!!");
            $title      = &checknull($FORM{'title'},"ÁôÑÔ±¾ÃûÏî²»ÄÜÎª¿Õ!!");
            $url        = &checknull($FORM{'homepage'}    ,"Ö÷Ò³µØÖ·²»ÄÜÎª¿Õ!!");
            $pagenum    = &checknull($FORM{'recode'}  ,"Ã¿Ò³¼ÇÂ¼ÊıÏî²»ÄÜÎª¿Õ!!");
            if (!($email =~ /.*\@.*\..*/))
              {
               &errorinput("ÄãÊäÈëÁËÒ»¸ö´íÎóµÄµç×ÓÓÊ¼şµØÖ·£¡£¡£¡");
              }
            if (!($url   =~ /http:\/\/.*\..*/))
              {
               &errorinput("ÄãÊäÈëÁËÒ»¸ö´íÎóµÄÖ÷Ò³µØÖ·£¡£¡£¡");
              }
       	    dbmopen(%USERFILE,"$userpath/alluser.db",0666);
            foreach (%USERFILE)
              {
               if ($_ =~ "¡¬$FORM{'username'}¡¬")
                  {
                   &errorinput("´ËÓÃ»§ÒÑ±»×¢²á!!Çë¸ü»»ÓÃ»§Ãû!!");
                  }
               if ($_ =~ "¡¬$FORM{'homepage'}¡¬")
                  {
                   &errorinput("´ËÖ÷Ò³ÒÑ¾­×¢²á¹ı±¾ÁôÑÔ±¾!!²»ÄÜÍê³ÉÄúµÄÉêÇë!!");
                  }
               if ($_ =~ "¡¬$FORM{'emailaddress'}¡¬")
                  {
                   &errorinput("´ËĞÅÏäÒÑ¾­×¢²á¹ı±¾ÁôÑÔ±¾!!²»ÄÜÍê³ÉÄúµÄÉêÇë!!");
                  }
              }
            $date_time  = sprintf ("%04d/%02d/%02d",$year,$mon,$mday);
            if (($FORM{'userpass'} eq "") || ($FORM{'userpass1'} eq ""))
              {
               &errorinput("ÃÜÂë»òÈ·ÈÏÃÜÂë²»ÄÜÎª¿Õ, ÇëÖØĞÂÊäÈë!!");
              }
            elsif ($FORM {'userpass'} ne $FORM {'userpass1'})
              {
               &errorinput("ÃÜÂëÓëÈ·ÈÏÃÜÂë²»Í¬, ÇëÖØĞÂÊäÈë!!");
              }
            else
              {
               $pass   = $FORM{'userpass'};
              }
            $newuserno  = sprintf ("%04d%02d%02d%02d%02d%02d",$year,$mon,$mday,$hour,$min,$sec);
            $ipaddress  = $ENV{'REMOTE_ADDR'};
            dbmopen(%USERFILE,"$userpath/alluser.db",0666);
            $USERFILE{$newuserno} = "start¡¬$name¡¬$pass¡¬$email¡¬$url¡¬$title¡¬$pagenum¡¬$ipaddress¡¬$date_time¡¬end¡¬\n";
            dbmclose(%USERFILE);
           }
        else
           {
            dbmopen(%USERFILE,"$userpath/alluser.db",0666);
            @userno=keys %USERFILE;
            @userno=sort @userno;
            foreach (@userno)
              {
               ($mark,$name111,$pass111,$email111,$url111,$title111,$pagenum111,$ipaddress,$date_time,$markend,$last)=split(/¡¬/,$USERFILE{$_});
               if ($USERFILE{$_} =~ "$FORM{'username'}")
                 {
                  if (($name111 eq "$FORM{'username'}") && ($pass111 eq "$FORM{'userpass'}"))
                    {
                     $name       = &checknull($FORM{'username'}      ,"Ãû×ÖÏî²»ÄÜÎª¿Õ!!");
                     $email      = &checknull($FORM{'emailaddress'}  ,"µç×ÓÓÊ¼şÏî²»ÄÜÎª¿Õ!!");
                     $title      = &checknull($FORM{'title'}         ,"ÁôÑÔ±¾ÃûÏî²»ÄÜÎª¿Õ!!");
                     $url        = &checknull($FORM{'homepage'}      ,"Ö÷Ò³µØÖ·²»ÄÜÎª¿Õ!!");
                     $pagenum    = &checknull($FORM{'recode'}        ,"Ã¿Ò³¼ÇÂ¼ÊıÏî²»ÄÜÎª¿Õ!!");
                     if ($FORM{'userpass1'} eq "")
                        {
                         $pass = $FORM{'userpass'};
                        }
                     else
                        {
                         $pass = $FORM{'userpass1'};
                        }
                     $USERFILE{$_} = "start¡¬$name¡¬$pass¡¬$email¡¬$url¡¬$title¡¬$pagenum¡¬$ipaddress¡¬$date_time¡¬end¡¬\n";
                    }
                 else
                    {
                     &errorinput("ÄãµÄÃÜÂë²»¶Ô, ²»ÄÜÍê³ÉĞŞ¸Ä!!");
                    }
                }
              }
            dbmclose(%USERFILE);
           }
&pagestyle;
print <<PRINTHTML;
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
$pagestyle
<title>ÉêÇë³É¹¦</title></head>
<BODY bgcolor=$gbbgcolor $gbbody><center>
<table width=$tablewidth align=center cellspacing=0 cellpadding=0  border=0 bgcolor=$tbcolor><tr><td>
      <table width=100% cellspacing=1 cellpadding=4 border=0 height="100%">
        <tr>
          <td bgcolor=$btbgcolor colspan="2">
            <div align="center"><font color=$btfont>¹§Ï² <font color="#ff0000">$name</font> £¬ÄãÒÑ³É¹¦ÉêÇë(ĞŞ¸Ä)ÁËÄúµÄÁôÑÔ°å£¡</font></div>
          </td>
        </tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ÓÃ »§ Ãû£º</td>
<td width="70%">&nbsp;$name</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ÓÃ»§ÃÜÂë£º</td>
<td width="70%">&nbsp;ÎªÁËÄúµÄ°²È«£¬²»ÏÔÊ¾ÄúµÄÁôÑÔ±¾ÃÜÂë£¡</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ÁôÑÔ±¾Ãû£º</td>
<td width="70%">&nbsp;$title</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">Ã¿Ò³¼ÇÂ¼£º</td>
<td width="70%">&nbsp;$pagenum</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">ĞÅÏäµØÖ·£º</td>
<td width="70%">&nbsp;$email</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">Ö÷Ò³µØÖ·£º</td>
<td width="70%">&nbsp;$url</td>
</tr>
<tr bgcolor=$lybgcolor>
<td width="30%" align="center">²é¿´ÁôÑÔ£º</td>
<td width="70%">&nbsp;<a href = $cgiurl/gbook.cgi?user=$name>$cgiurl/gbook.cgi?user=$name</a></td>
</tr>
<tr><td bgcolor=$btbgcolor colspan="2"><div align="center">
<font color=$btfont>ÄúµÄ´úÂëÒÑ¾­Í¨¹ı<a href = mailto:$email><font color="#ff0000"> $email </font></a>·¢µ½ÁËÄãµÄĞÅÏäÖĞ¡£</font></div>
</td></tr></table>
</td></tr></table>

PRINTHTML
&sendmail()
       }
}
######################################################
sub mypath{
local
$temp;
$temp=__FILE__;
$temp=~ s/\\/\//g if ($temp=~/\\/);
if ($temp) {$mypath=substr($temp,0,rindex($temp,"/"));}
else {
$mypath=substr($ENV{'PATH_TRANSLATED'},0,rindex($ENV{'PATH_TRANSLATED'},"\\"));
$mypath=~ s/\\/\//g;
}
return
$mypath;
}